From e474f0257bd8efc5671890ad1db6e119f5b1131c Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 20 Oct 2022 18:46:48 +0200
Subject: [PATCH 31/39] Revert "blk-wbt: make enable_state more accurate"

This reverts commit 3d608a694b9a1da0988b891f28019949c1e20210.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 block/blk-wbt.c |  7 +------
 block/blk-wbt.h | 12 +++++-------
 2 files changed, 6 insertions(+), 13 deletions(-)

diff --git a/block/blk-wbt.c b/block/blk-wbt.c
index 4680691a9..c5a8c1002 100644
--- a/block/blk-wbt.c
+++ b/block/blk-wbt.c
@@ -435,13 +435,8 @@ void wbt_set_min_lat(struct request_queue *q, u64 val)
 	struct rq_qos *rqos = wbt_rq_qos(q);
 	if (!rqos)
 		return;
-
 	RQWB(rqos)->min_lat_nsec = val;
-	if (val)
-		RQWB(rqos)->enable_state = WBT_STATE_ON_MANUAL;
-	else
-		RQWB(rqos)->enable_state = WBT_STATE_OFF_MANUAL;
-
+	RQWB(rqos)->enable_state = WBT_STATE_ON_MANUAL;
 	wbt_update_limits(RQWB(rqos));
 }
 
diff --git a/block/blk-wbt.h b/block/blk-wbt.h
index 7fe98638f..7e44eccc6 100644
--- a/block/blk-wbt.h
+++ b/block/blk-wbt.h
@@ -28,15 +28,13 @@ enum {
 };
 
 /*
- * If current state is WBT_STATE_ON/OFF_DEFAULT, it can be covered to any other
- * state, if current state is WBT_STATE_ON/OFF_MANUAL, it can only be covered
- * to WBT_STATE_OFF/ON_MANUAL.
+ * Enable states. Either off, or on by default (done at init time),
+ * or on through manual setup in sysfs.
  */
 enum {
-	WBT_STATE_ON_DEFAULT	= 1,	/* on by default */
-	WBT_STATE_ON_MANUAL	= 2,	/* on manually by sysfs */
-	WBT_STATE_OFF_DEFAULT	= 3,	/* off by default */
-	WBT_STATE_OFF_MANUAL	= 4,	/* off manually by sysfs */
+	WBT_STATE_ON_DEFAULT	= 1,
+	WBT_STATE_ON_MANUAL	= 2,
+	WBT_STATE_OFF_DEFAULT
 };
 
 struct rq_wb {
-- 
2.38.0.rc1.6.g4fd6c5e444

