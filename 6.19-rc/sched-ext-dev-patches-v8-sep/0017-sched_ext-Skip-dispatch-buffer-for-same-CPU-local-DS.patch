From eabdb9524f362df51b6c1e39d5c50bcdc2909768 Mon Sep 17 00:00:00 2001
From: Andrea Righi <arighi@nvidia.com>
Date: Wed, 28 Jan 2026 16:57:07 +0100
Subject: [PATCH 17/17] sched_ext: Skip dispatch buffer for same-CPU local DSQ
 dispatches

Signed-off-by: Andrea Righi <arighi@nvidia.com>
---
 kernel/sched/ext.c | 48 ++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 48 insertions(+)

diff --git a/kernel/sched/ext.c b/kernel/sched/ext.c
index e5c55b78d..4df53358f 100644
--- a/kernel/sched/ext.c
+++ b/kernel/sched/ext.c
@@ -5995,6 +5995,54 @@ static void scx_dsq_insert_commit(struct scx_sched *sch, struct task_struct *p,
 		return;
 	}
 
+	/*
+	 * Fast path: Skip dispatch buffer for same-CPU local DSQ dispatches.
+	 * This eliminates buffering overhead when the BPF scheduler dispatches
+	 * tasks to the local DSQ of the current CPU from ops.dispatch().
+	 */
+	if (dsq_id == SCX_DSQ_LOCAL && dspc->rq == this_rq()) {
+		struct rq *rq = dspc->rq;
+		unsigned long opss, qseq;
+
+		qseq = atomic_long_read(&p->scx.ops_state) & SCX_OPSS_QSEQ_MASK;
+
+		/*
+		 * Fast validation and claim: try to transition from QUEUED to
+		 * DISPATCHING if qseq matches.
+		 */
+retry_fast:
+		opss = atomic_long_read(&p->scx.ops_state);
+
+		switch (opss & SCX_OPSS_STATE_MASK) {
+		case SCX_OPSS_DISPATCHING:
+		case SCX_OPSS_NONE:
+			/* Someone else got to it or task is gone */
+			return;
+		case SCX_OPSS_QUEUED:
+			if ((opss & SCX_OPSS_QSEQ_MASK) != qseq)
+				return;
+			if (likely(atomic_long_try_cmpxchg(&p->scx.ops_state,
+							   &opss,
+							   SCX_OPSS_DISPATCHING)))
+				break;
+			goto retry_fast;
+		case SCX_OPSS_QUEUEING:
+			wait_ops_state(p, opss);
+			goto retry_fast;
+		}
+
+		/* Successfully claimed, now dispatch directly */
+		if (!(p->scx.flags & SCX_TASK_QUEUED))
+			return;
+
+		touch_core_sched_dispatch(rq, p);
+
+		dispatch_enqueue(sch, &rq->scx.local_dsq, p,
+				 enq_flags | SCX_ENQ_CLEAR_OPSS);
+		dspc->nr_tasks++;
+		return;
+	}
+
 	if (unlikely(dspc->cursor >= scx_dsp_max_batch)) {
 		scx_error(sch, "dispatch buffer overflow");
 		return;
-- 
2.52.0

