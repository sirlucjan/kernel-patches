From e96bea3a2686176a4575ed89e4497de77d867b40 Mon Sep 17 00:00:00 2001
From: Antheas Kapenekakis <lkml@antheas.dev>
Date: Wed, 16 Jul 2025 19:01:47 +0200
Subject: [PATCH 085/108] Input: evdev - allow releasing keys on grab

Signed-off-by: Antheas Kapenekakis <lkml@antheas.dev>
---
 drivers/input/evdev.c            | 10 +++---
 drivers/input/input.c            | 52 ++++++++++++++++++--------------
 drivers/input/tests/input_test.c |  6 ++--
 include/linux/input.h            |  2 +-
 4 files changed, 39 insertions(+), 31 deletions(-)

diff --git a/drivers/input/evdev.c b/drivers/input/evdev.c
index 90ff6be85..6e2808616 100644
--- a/drivers/input/evdev.c
+++ b/drivers/input/evdev.c
@@ -329,14 +329,14 @@ static void evdev_free(struct device *dev)
  * Grabs an event device (along with underlying input device).
  * This function is called with evdev->mutex taken.
  */
-static int evdev_grab(struct evdev *evdev, struct evdev_client *client)
+static int evdev_grab(struct evdev *evdev, struct evdev_client *client, bool clean)
 {
 	int error;
 
 	if (evdev->grab)
 		return -EBUSY;
 
-	error = input_grab_device(&evdev->handle);
+	error = input_grab_device(&evdev->handle, clean);
 	if (error)
 		return error;
 
@@ -1082,8 +1082,10 @@ static long evdev_do_ioctl(struct file *file, unsigned int cmd,
 		return 0;
 
 	case EVIOCGRAB:
-		if (p)
-			return evdev_grab(evdev, client);
+		if (p == (void *)2)
+			return evdev_grab(evdev, client, true);
+		else if (p)
+			return evdev_grab(evdev, client, false);
 		else
 			return evdev_ungrab(evdev, client);
 
diff --git a/drivers/input/input.c b/drivers/input/input.c
index a500e1e27..81e32030c 100644
--- a/drivers/input/input.c
+++ b/drivers/input/input.c
@@ -509,29 +509,6 @@ void input_copy_abs(struct input_dev *dst, unsigned int dst_axis,
 }
 EXPORT_SYMBOL(input_copy_abs);
 
-/**
- * input_grab_device - grabs device for exclusive use
- * @handle: input handle that wants to own the device
- *
- * When a device is grabbed by an input handle all events generated by
- * the device are delivered only to this handle. Also events injected
- * by other input handles are ignored while device is grabbed.
- */
-int input_grab_device(struct input_handle *handle)
-{
-	struct input_dev *dev = handle->dev;
-
-	scoped_cond_guard(mutex_intr, return -EINTR, &dev->mutex) {
-		if (dev->grab)
-			return -EBUSY;
-
-		rcu_assign_pointer(dev->grab, handle);
-	}
-
-	return 0;
-}
-EXPORT_SYMBOL(input_grab_device);
-
 static void __input_release_device(struct input_handle *handle)
 {
 	struct input_dev *dev = handle->dev;
@@ -1735,6 +1712,35 @@ void input_reset_device(struct input_dev *dev)
 }
 EXPORT_SYMBOL(input_reset_device);
 
+/**
+ * input_grab_device - grabs device for exclusive use
+ * @handle: input handle that wants to own the device
+ * @release_keys: whether to release pressed keys before grabbing
+ *
+ * When a device is grabbed by an input handle all events generated by
+ * the device are delivered only to this handle. Also events injected
+ * by other input handles are ignored while device is grabbed.
+ */
+int input_grab_device(struct input_handle *handle, bool release_keys)
+{
+	struct input_dev *dev = handle->dev;
+
+	scoped_cond_guard(mutex_intr, return -EINTR, &dev->mutex) {
+		guard(spinlock_irqsave)(&dev->event_lock);
+
+		if (dev->grab)
+			return -EBUSY;
+
+		if (release_keys && input_dev_release_keys(dev))
+			input_handle_event(dev, EV_SYN, SYN_REPORT, 1);
+
+		rcu_assign_pointer(dev->grab, handle);
+	}
+
+	return 0;
+}
+EXPORT_SYMBOL(input_grab_device);
+
 static int input_inhibit_device(struct input_dev *dev)
 {
 	guard(mutex)(&dev->mutex);
diff --git a/drivers/input/tests/input_test.c b/drivers/input/tests/input_test.c
index e105ce71a..ff6d195ba 100644
--- a/drivers/input/tests/input_test.c
+++ b/drivers/input/tests/input_test.c
@@ -145,18 +145,18 @@ static void input_test_grab(struct kunit *test)
 	handle.dev = input_get_device(input_dev);
 	handle.name = dev_name(&input_dev->dev);
 	handle.handler = &handler;
-	res = input_grab_device(&handle);
+	res = input_grab_device(&handle, false);
 	KUNIT_ASSERT_TRUE(test, res == 0);
 
 	test_handle.dev = input_get_device(input_dev);
 	test_handle.name = dev_name(&input_dev->dev);
 	test_handle.handler = &handler;
-	res = input_grab_device(&test_handle);
+	res = input_grab_device(&test_handle, false);
 	KUNIT_ASSERT_EQ(test, res, -EBUSY);
 
 	input_release_device(&handle);
 	input_put_device(input_dev);
-	res = input_grab_device(&test_handle);
+	res = input_grab_device(&test_handle, false);
 	KUNIT_ASSERT_TRUE(test, res == 0);
 	input_put_device(input_dev);
 }
diff --git a/include/linux/input.h b/include/linux/input.h
index 7d7cb0593..ef4dd65d1 100644
--- a/include/linux/input.h
+++ b/include/linux/input.h
@@ -420,7 +420,7 @@ int input_handler_for_each_handle(struct input_handler *, void *data,
 int input_register_handle(struct input_handle *);
 void input_unregister_handle(struct input_handle *);
 
-int input_grab_device(struct input_handle *);
+int input_grab_device(struct input_handle *, bool release_keys);
 void input_release_device(struct input_handle *);
 
 int input_open_device(struct input_handle *);
-- 
2.52.0

