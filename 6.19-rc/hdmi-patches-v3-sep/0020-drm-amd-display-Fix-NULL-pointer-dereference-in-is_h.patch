From 65a76e237feb4845b52a227f58f23a886d3bde4a Mon Sep 17 00:00:00 2001
From: Peter Jung <admin@ptr1337.dev>
Date: Sat, 31 Jan 2026 13:00:00 +0100
Subject: [PATCH 20/20] drm/amd/display: Fix NULL pointer dereference in
 is_hdmi_allm_mode()

The is_hdmi_allm_mode() function dereferences stream->link->local_sink
without first checking if local_sink is NULL. This can cause a kernel
crash during HDMI hotplug events when a TV is turned on while the HDMI
cable is already connected.

During display detection, there is a timing window where local_sink has
not yet been set by detect_link_and_local_sink(), but create_stream_for_sink()
may already be called, leading to mod_build_hf_vsif_infopacket() accessing
the NULL pointer.

Add a NULL check for local_sink before dereferencing it.

Closes: https://github.com/CachyOS/linux-cachyos/issues/680
Fixes: 454172a94fc2 ("drm/amd/display: Add parameter to control ALLM behavior")
Signed-off-by: Peter Jung <admin@ptr1337.dev>
---
 drivers/gpu/drm/amd/display/modules/info_packet/info_packet.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/display/modules/info_packet/info_packet.c b/drivers/gpu/drm/amd/display/modules/info_packet/info_packet.c
index cf5a1ccb8..a4edbf44a 100644
--- a/drivers/gpu/drm/amd/display/modules/info_packet/info_packet.c
+++ b/drivers/gpu/drm/amd/display/modules/info_packet/info_packet.c
@@ -433,7 +433,8 @@ void mod_build_vsc_infopacket(const struct dc_stream_state *stream,
 static bool is_hdmi_allm_mode(const struct dc_stream_state *stream)
 {
 	/* Sink doesn't expose ALLM support in edid */
-	if (!stream->link->local_sink->edid_caps.allm)
+	if (!stream->link->local_sink ||
+	    !stream->link->local_sink->edid_caps.allm)
 		return false;
 
 	switch (amdgpu_allm_mode) {
-- 
2.52.0

