From ce542117db74a0578b22b905b2a3505ce7b769ac Mon Sep 17 00:00:00 2001
From: Andrea Righi <arighi@nvidia.com>
Date: Wed, 28 Jan 2026 23:05:22 +0100
Subject: [PATCH 14/15] sched_ext: Skip resched for IN_BALANCE CPUs

Signed-off-by: Andrea Righi <arighi@nvidia.com>
---
 kernel/sched/ext.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/kernel/sched/ext.c b/kernel/sched/ext.c
index 386195088..494189fb0 100644
--- a/kernel/sched/ext.c
+++ b/kernel/sched/ext.c
@@ -2158,8 +2158,13 @@ static void dispatch_to_local_dsq(struct scx_sched *sch, struct rq *rq,
 			locked_rq = dst_rq;
 		}
 
-		/* if the destination CPU is idle, wake it up */
-		if (sched_class_above(p->sched_class, dst_rq->curr->sched_class))
+		/*
+		 * If the destination CPU is idle/in-balance, wake it up.
+		 * Skip resched if already in balance - CPU is already looking
+		 * for tasks and will pick this up immediately.
+		 */
+		if (!(dst_rq->scx.flags & SCX_RQ_IN_BALANCE) &&
+		    sched_class_above(p->sched_class, dst_rq->curr->sched_class))
 			resched_curr(dst_rq);
 	}
 
-- 
2.52.0

