From 34c4f929168fb832d148c79ec7db6deb2a3112f2 Mon Sep 17 00:00:00 2001
From: Eric Naim <dnaim@cachyos.org>
Date: Fri, 12 Dec 2025 16:13:19 +0800
Subject: [PATCH 10/22] Revert "x86/vmscape: Remove LFENCE from BHB clearing
 long loop"

This reverts commit 9e2cacb9887e3432621729c36bdedcae4521d5b1.

Signed-off-by: Eric Naim <dnaim@cachyos.org>
---
 arch/x86/entry/entry_64.S            | 32 +++++++++++-----------------
 arch/x86/include/asm/entry-common.h  |  2 +-
 arch/x86/include/asm/nospec-branch.h |  4 ++--
 3 files changed, 15 insertions(+), 23 deletions(-)

diff --git a/arch/x86/entry/entry_64.S b/arch/x86/entry/entry_64.S
index bb456a3c6..f5f62af08 100644
--- a/arch/x86/entry/entry_64.S
+++ b/arch/x86/entry/entry_64.S
@@ -1525,6 +1525,10 @@ SYM_CODE_END(rewind_stack_and_make_dead)
  * Target Selection, rather than taking the slowpath via its_return_thunk.
  */
 .macro	__CLEAR_BHB_LOOP outer_loop_count:req, inner_loop_count:req
+	ANNOTATE_NOENDBR
+	push	%rbp
+	mov	%rsp, %rbp
+
 	movl	$\outer_loop_count, %ecx
 	ANNOTATE_INTRA_FUNCTION_CALL
 	call	1f
@@ -1556,7 +1560,10 @@ SYM_CODE_END(rewind_stack_and_make_dead)
 	jnz	1b
 .Lret2_\@:
 	RET
-5:
+5:	lfence
+
+	pop	%rbp
+	RET
 .endm
 
 /*
@@ -1566,15 +1573,7 @@ SYM_CODE_END(rewind_stack_and_make_dead)
  * setting BHI_DIS_S for the guests.
  */
 SYM_FUNC_START(clear_bhb_loop)
-	ANNOTATE_NOENDBR
-	push	%rbp
-	mov	%rsp, %rbp
-
 	__CLEAR_BHB_LOOP 5, 5
-
-	lfence
-	pop	%rbp
-	RET
 SYM_FUNC_END(clear_bhb_loop)
 EXPORT_SYMBOL_GPL(clear_bhb_loop)
 STACK_FRAME_NON_STANDARD(clear_bhb_loop)
@@ -1585,15 +1584,8 @@ STACK_FRAME_NON_STANDARD(clear_bhb_loop)
  * protects the kernel, but to mitigate the guest influence on the host
  * userspace either IBPB or this sequence should be used. See VMSCAPE bug.
  */
-SYM_FUNC_START(clear_bhb_long_loop_no_barrier)
-	ANNOTATE_NOENDBR
-	push	%rbp
-	mov	%rsp, %rbp
-
+SYM_FUNC_START(clear_bhb_long_loop)
 	__CLEAR_BHB_LOOP 12, 7
-
-	pop	%rbp
-	RET
-SYM_FUNC_END(clear_bhb_long_loop_no_barrier)
-EXPORT_SYMBOL_GPL(clear_bhb_long_loop_no_barrier)
-STACK_FRAME_NON_STANDARD(clear_bhb_long_loop_no_barrier)
+SYM_FUNC_END(clear_bhb_long_loop)
+EXPORT_SYMBOL_GPL(clear_bhb_long_loop)
+STACK_FRAME_NON_STANDARD(clear_bhb_long_loop)
diff --git a/arch/x86/include/asm/entry-common.h b/arch/x86/include/asm/entry-common.h
index c70454bdd..b7b9af1b6 100644
--- a/arch/x86/include/asm/entry-common.h
+++ b/arch/x86/include/asm/entry-common.h
@@ -98,7 +98,7 @@ static inline void arch_exit_to_user_mode_prepare(struct pt_regs *regs,
 		if (cpu_feature_enabled(X86_FEATURE_IBPB_EXIT_TO_USER))
 			indirect_branch_prediction_barrier();
 		else if (cpu_feature_enabled(X86_FEATURE_CLEAR_BHB_EXIT_TO_USER))
-			clear_bhb_long_loop_no_barrier();
+			clear_bhb_long_loop();
 
 		this_cpu_write(x86_pred_flush_pending, false);
 	}
diff --git a/arch/x86/include/asm/nospec-branch.h b/arch/x86/include/asm/nospec-branch.h
index 3bcf9f180..00730cc22 100644
--- a/arch/x86/include/asm/nospec-branch.h
+++ b/arch/x86/include/asm/nospec-branch.h
@@ -388,9 +388,9 @@ extern void write_ibpb(void);
 
 #ifdef CONFIG_X86_64
 extern void clear_bhb_loop(void);
-extern void clear_bhb_long_loop_no_barrier(void);
+extern void clear_bhb_long_loop(void);
 #else
-static inline void clear_bhb_long_loop_no_barrier(void) {}
+static inline void clear_bhb_long_loop(void) {}
 #endif
 
 extern void (*x86_return_thunk)(void);
-- 
2.52.0

