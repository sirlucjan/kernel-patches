From 0ff117fc55f9bcee0ccd33a6fb67e1dd40f18d41 Mon Sep 17 00:00:00 2001
From: Peter Jung <admin@ptr1337.dev>
Date: Sat, 31 Jan 2026 13:14:34 +0100
Subject: [PATCH 061/100] Revert "drm/amd/display: Do not rely on NULL pointer
 detection"

This reverts commit 90cbec2dcb74ccc3c9759688b8292e08474b8e8e.
---
 .../gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c | 26 +++++++++----------
 1 file changed, 13 insertions(+), 13 deletions(-)

diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index 62e3cd6b7..231aa4220 100644
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@ -12910,9 +12910,9 @@ static int parse_amd_vsdb_cea(struct amdgpu_dm_connector *aconnector,
 			      const struct edid *edid,
 			      struct amdgpu_hdmi_vsdb_info *vsdb_info)
 {
-	struct amdgpu_hdmi_vsdb_info vsdb_local = {0};
 	u8 *edid_ext = NULL;
 	int i;
+	bool valid_vsdb_found = false;
 
 	/*----- drm_find_cea_extension() -----*/
 	/* No EDID or EDID extensions */
@@ -12933,11 +12933,9 @@ static int parse_amd_vsdb_cea(struct amdgpu_dm_connector *aconnector,
 	if (edid_ext[0] != CEA_EXT)
 		return -ENODEV;
 
-	if (!parse_edid_cea(aconnector, edid_ext, EDID_LENGTH, &vsdb_local))
-		return -ENODEV;
+	valid_vsdb_found = parse_edid_cea(aconnector, edid_ext, EDID_LENGTH, vsdb_info);
 
-	*vsdb_info = vsdb_local;
-	return i;
+	return valid_vsdb_found ? i : -ENODEV;
 }
 
 static bool is_monitor_range_invalid(struct drm_connector *conn)
@@ -12968,7 +12966,7 @@ static void monitor_range_from_vsdb(struct drm_connector *conn,
  * try getting upper bound from AMD vsdb (if passed).
  *
  * @conn: drm_connector with HDMI VRR info
- * @vsdb: AMD vsdb from CAE
+ * @vsdb: AMD vsdb from CAE. Can be NULL if not found.
  */
 static void monitor_range_from_hdmi(struct drm_connector *conn,
 				    const struct amdgpu_hdmi_vsdb_info *vsdb)
@@ -12978,7 +12976,7 @@ static void monitor_range_from_hdmi(struct drm_connector *conn,
 	u16 vrr_max = caps->vrr_max;
 
 	/* Try getting upper vrr bound from AMD vsdb */
-	if (vrr_max == 0 && vsdb->max_refresh_rate_hz > 0)
+	if (vrr_max == 0 && vsdb)
 		vrr_max = vsdb->max_refresh_rate_hz;
 
 	/* Use max possible BRR value as a last resort */
@@ -13074,6 +13072,8 @@ void amdgpu_dm_update_freesync_caps(struct drm_connector *connector,
 
 	/* Gather all data */
 	edid = drm_edid_raw(drm_edid); // FIXME: Get rid of drm_edid_raw()
+	valid_vsdb_cea = parse_amd_vsdb_cea(amdgpu_dm_connector, edid, &vsdb_info) >= 0;
+	vsdb_freesync = valid_vsdb_cea && vsdb_info.freesync_supported;
 	hdmi_vrr = &connector->display_info.hdmi.vrr_cap;
 
 	if (amdgpu_dm_connector->dc_link) {
@@ -13094,11 +13094,11 @@ void amdgpu_dm_update_freesync_caps(struct drm_connector *connector,
 		 * Many monitors expose AMD vsdb in CAE even for DP and their
 		 * monitor ranges do not contain Range Limits Only flag
 		 */
-		if (is_monitor_range_invalid(connector))
+		if (valid_vsdb_cea && is_monitor_range_invalid(connector))
 			monitor_range_from_vsdb(connector, &vsdb_info);
 
 		/* Use bigger range if found in AMD vsdb */
-		if (compare_ranges(connector, &vsdb_info))
+		if (valid_vsdb_cea && compare_ranges(connector, &vsdb_info))
 			monitor_range_from_vsdb(connector, &vsdb_info);
 
 		if (dpcd_caps.allow_invalid_MSA_timing_param)
@@ -13119,8 +13119,8 @@ void amdgpu_dm_update_freesync_caps(struct drm_connector *connector,
 		/* Prefer HDMI VRR */
 		if (hdmi_vrr->supported) {
 			amdgpu_dm_connector->as_type = ADAPTIVE_SYNC_TYPE_HDMI;
-			monitor_range_from_hdmi(connector, &vsdb_info);
-		} else if (vsdb_info.freesync_supported)
+			monitor_range_from_hdmi(connector, valid_vsdb_cea ? &vsdb_info : NULL);
+		} else if (vsdb_freesync)
 			monitor_range_from_vsdb(connector, &vsdb_info);
 
 		freesync_capable = copy_range_to_amdgpu_connector(connector);
@@ -13129,8 +13129,8 @@ void amdgpu_dm_update_freesync_caps(struct drm_connector *connector,
 	} else if (pcon_allowed) {
 		/* Prefer HDMI VRR */
 		if (hdmi_vrr->supported)
-			monitor_range_from_hdmi(connector, &vsdb_info);
-		else if (vsdb_info.freesync_supported) {
+			monitor_range_from_hdmi(connector, valid_vsdb_cea ? &vsdb_info : NULL);
+		else if (vsdb_freesync) {
 			amdgpu_dm_connector->vsdb_info = vsdb_info;
 			monitor_range_from_vsdb(connector, &vsdb_info);
 		}
-- 
2.52.0

